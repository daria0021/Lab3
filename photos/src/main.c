#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "image.h"
#include "bmp.h"
#include "cli.h"
#include "pipeline.h"

int main(int argc, char** argv) {
    printf("‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó\n");
    printf("‚ïë                 ImageCraft - –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ1     ‚ïë\n");
    printf("‚ïë                 –§–ü–ú, –õ–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–∞—è —Ä–∞–±–æ—Ç–∞                ‚ïë\n");
    printf("‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n");
    printf("\n");

    // –ü–∞—Ä—Å–∏–Ω–≥ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
    CLIArgs* args = cli_parse_args(argc, argv);
    if (!args) {
        fprintf(stderr, "‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å –∞—Ä–≥—É–º–µ–Ω—Ç—ã\n");
        return EXIT_FAILURE;
    }

    // –í—ã–≤–æ–¥ —Å–ø—Ä–∞–≤–∫–∏, –µ—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–æ
    if (args->show_help) {
        cli_print_help();
        cli_free_args(args);
        return EXIT_SUCCESS;
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –ø–∞—Ä—Å–∏–Ω–≥–∞
    if (args->error) {
        cli_print_error(args);
        cli_free_args(args);
        return EXIT_FAILURE;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –≤—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    if (!bmp_is_valid_format(args->input_file)) {
        fprintf(stderr, "‚ùå –û–®–ò–ë–ö–ê: –§–∞–π–ª '%s' –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –≤–∞–ª–∏–¥–Ω—ã–º BMP —Ñ–∞–π–ª–æ–º\n", args->input_file);
        fprintf(stderr, "   –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ 24-–±–∏—Ç–Ω—ã–µ BMP –±–µ–∑ —Å–∂–∞—Ç–∏—è\n");
        cli_free_args(args);
        return EXIT_FAILURE;
    }

    // –ß—Ç–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    printf("üìÅ –ß—Ç–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: %s\n", args->input_file);
    Image* image = bmp_read(args->input_file);
    if (!image) {
        fprintf(stderr, "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–∑ '%s'\n", args->input_file);
        fprintf(stderr, "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ –∏ –µ–≥–æ —Ñ–æ—Ä–º–∞—Ç\n");
        cli_free_args(args);
        return EXIT_FAILURE;
    }

    printf("‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–≥—Ä—É–∂–µ–Ω–æ: %d x %d –ø–∏–∫—Å–µ–ª–µ–π\n", image->width, image->height);

    // –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    if (args->pipeline->count > 0) {
        printf("\nüîß –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ —Ñ–∏–ª—å—Ç—Ä–æ–≤...\n");
        pipeline_apply(args->pipeline, image);
    } else {
        printf("\n‚ÑπÔ∏è  –§–∏–ª—å—Ç—Ä—ã –Ω–µ —É–∫–∞–∑–∞–Ω—ã, —Å–æ—Ö—Ä–∞–Ω—è—é –∏—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ\n");
    }

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    printf("üíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: %s\n", args->output_file);
    if (!bmp_write(args->output_file, image)) {
        fprintf(stderr, "‚ùå –û–®–ò–ë–ö–ê: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ '%s'\n", args->output_file);
        fprintf(stderr, "   –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏ —Å–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ –¥–∏—Å–∫–µ\n");
        image_destroy(image);
        cli_free_args(args);
        return EXIT_FAILURE;
    }

    // –û—á–∏—Å—Ç–∫–∞
    image_destroy(image);
    cli_free_args(args);

    printf("\nüéâ –£–°–ü–ï–•! –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞.\n");
    printf("   –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–∞–π–ª.\n\n");

    return EXIT_SUCCESS;
}